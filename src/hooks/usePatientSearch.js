import { useEffect, useState } from "react";

import API_URL from '../env_vars';

// generic debounce â€“ re-usable everywhere
//function useDebounce<T>(value: T, delay = 500) {
function useDebounce(value, delay = 500) {
    const [debounced, setDebounced] = useState(value);

    useEffect(() => {
        const id = setTimeout(() => setDebounced(value), delay);
        return () => clearTimeout(id);
    }, [value, delay]);

    return debounced;
}

export function usePatientSearch(initialQuery = "") {
    const [query, setQuery]   = useState(initialQuery);
    const [results, setResults] = useState([]);
    const [loading, setLoading] = useState(false);
    const debouncedQuery = useDebounce(query, 500);

    useEffect(() => {
        if (debouncedQuery.trim().length < 2) {
            setResults([]);
            return;
        }

        let cancelled = false;
        (async () => {
            setLoading(true);
            try {
                const res  = await fetch(`${API_URL}/api/patients/search?q=${debouncedQuery}`);
                const data = await res.json();
                if (!cancelled) setResults(data);
            } finally {
                if (!cancelled) setLoading(false);
            }
        })();

        return () => { cancelled = true; };
    }, [debouncedQuery]);

    return { query, setQuery, results, loading };
}
